# Инструкции по установке и настройке

## Системные требования

- Python 3.8+
- SQLite3
- Доступ к интернету для работы с Telegram API

## Установка зависимостей

```bash
pip install python-telegram-bot flask
```

## Настройка переменных окружения

Создайте файл `.env` в корневой папке проекта:

```env
# Telegram Bot Token (получите у @BotFather)
TELEGRAM_BOT_TOKEN=your_bot_token_here

# ID администраторов (получите у @userinfobot)
ADMIN_ID=123456789
ADMIN_ID_2=987654321

# Порт для Flask API (по умолчанию 10000)
PORT=10000
```

## Запуск бота

```bash
python render_bot_final.py
```

## Инициализация базы данных

База данных создается автоматически при первом запуске бота. Файл `bot_database.db` будет создан в корневой папке проекта.

## Структура базы данных

### Таблица wallets
- `user_id` - ID пользователя Telegram (PRIMARY KEY)
- `username` - Username пользователя
- `first_name` - Имя пользователя
- `balance` - Баланс кошелька
- `created_at` - Дата создания кошелька
- `updated_at` - Дата последнего обновления

### Таблица wallet_transactions
- `id` - ID транзакции (AUTOINCREMENT)
- `user_id` - ID пользователя
- `transaction_type` - Тип транзакции (deposit, withdrawal, payment, refund, commission)
- `amount` - Сумма транзакции
- `description` - Описание транзакции
- `order_id` - ID заказа (если связан с заказом)
- `created_at` - Дата создания транзакции

### Таблица orders
- `id` - ID заказа (AUTOINCREMENT)
- `user_id` - ID пользователя
- `order_type` - Тип заказа (cards, transfers, crypto)
- `service_name` - Название услуги
- `amount` - Сумма заказа
- `commission` - Комиссия
- `total_amount` - Итоговая сумма
- `status` - Статус заказа
- `payment_method` - Способ оплаты
- `wallet_payment` - Оплата через кошелек
- `admin_notes` - Заметки администратора
- `created_at` - Дата создания заказа
- `updated_at` - Дата последнего обновления
- `completed_at` - Дата завершения заказа

### Таблица order_status_history
- `id` - ID записи (AUTOINCREMENT)
- `order_id` - ID заказа
- `status` - Статус заказа
- `admin_id` - ID администратора
- `notes` - Заметки
- `created_at` - Дата изменения статуса

## Команды бота

### Для пользователей
- `/start` - Главное меню
- `/menu` - Каталог услуг
- `/help` - Справка
- `/address` - Реквизиты для оплаты
- `/price` - Прайс-лист
- `/wallet` - Мой кошелек
- `/orders` - Мои заказы

### Для администраторов
- `/admin_orders` - Все заказы

## API эндпоинты

### Заказы
- `GET /admin/orders` - Получить все заказы
- `GET /admin/order/{order_id}` - Получить детали заказа
- `POST /admin/order/{order_id}/status` - Обновить статус заказа

### Кошельки
- `GET /admin/wallet/{user_id}` - Получить информацию о кошельке
- `POST /admin/wallet/{user_id}/deposit` - Пополнить кошелек
- `POST /admin/wallet/{user_id}/withdraw` - Вывести средства

## Мониторинг и логирование

Бот автоматически ведет логи всех операций. Логи выводятся в консоль и содержат:
- Информацию о создании заказов
- Транзакции кошельков
- Ошибки и предупреждения
- Действия администраторов

## Резервное копирование

Рекомендуется регулярно создавать резервные копии файла `bot_database.db`:

```bash
cp bot_database.db backup_$(date +%Y%m%d_%H%M%S).db
```

## Безопасность

1. **Храните токен бота в секрете** - не публикуйте его в открытом доступе
2. **Используйте HTTPS** - для продакшена настройте SSL сертификат
3. **Ограничьте доступ к API** - используйте файрвол для ограничения доступа к порту 10000
4. **Регулярно обновляйте зависимости** - следите за обновлениями библиотек

## Устранение неполадок

### Бот не запускается
1. Проверьте правильность токена
2. Убедитесь, что все зависимости установлены
3. Проверьте права доступа к папке

### Ошибки базы данных
1. Проверьте права доступа к файлу `bot_database.db`
2. Убедитесь, что SQLite3 установлен
3. Попробуйте удалить файл базы данных и перезапустить бота

### API не отвечает
1. Проверьте, что порт 10000 не занят другим процессом
2. Убедитесь, что файрвол не блокирует подключения
3. Проверьте логи Flask сервера

## Обновление бота

1. Остановите бота
2. Создайте резервную копию базы данных
3. Обновите код
4. Запустите бота заново

## Поддержка

При возникновении проблем:
1. Проверьте логи бота
2. Убедитесь, что все настройки корректны
3. Обратитесь к документации API
4. Свяжитесь с разработчиком
